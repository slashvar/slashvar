package cosine

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/require"
)

var (
	a       = []float32{0.0144894514, -0.0564095229, -0.0418090783, 0.0434705243, 0.0432062633, -0.0624103956, 0.0525009297, 0.0635857359, 0.0167658, 0.0161980335, -0.0293408297, 0.0467001311, -0.0197364688, -0.0122899357, 0.0702301636, 0.0720762163, 0.0086392, 0.0446979925, 0.0486529805, -0.0557762869, -0.0414227769, 0.0522107705, 0.0368089713, 0.0661764815, -0.0721974447, -0.0455682799, 0.0231055748, -0.0392697304, -0.0101105394, -0.070804961, -0.011400938, -0.00462412136, 0.067147918, 0.0624225698, 0.0182736777, 0.0144353127, 0.0651324317, 0.0133628491, -0.0178601984, 0.0545534082, -0.0613967367, -0.0249848366, 0.0779628, -0.0642735288, -0.018667765, -0.0273380969, 0.00843717344, -0.0305104982, 0.0492269658, 0.0507817, 0.0337303691, 0.0472468846, 0.0608160868, 0.051825203, -0.0278449487, -0.0519652702, 0.014454145, -0.043387454, 0.066217348, -0.0165923331, -0.0367123932, -0.00554667506, 0.0141742872, 0.0605871305, 0.0346849561, 0.0335003436, -0.0457747765, 0.0505600236, 0.0781271532, 0.065186277, -0.0329232141, 0.0508374609, 0.0298991278, 0.0374952704, -0.0592273027, 0.0710136443, 0.00580660719, 0.0138456319, 0.0437808633, 0.0598232858, -0.0335636884, -0.0129462108, -0.0744986, 0.0553324446, -0.0429101214, -0.0360198431, -0.00619543204, 0.000883213652, 0.0779383257, 0.049878791, -0.0645416, -0.00935973134, 0.00652567064, 0.0018271046, -0.0107837534, -0.0701458305, -0.0633332431, -0.045685757, 0.0154358307, 0.0161341969, 0.0069297147, -0.0722005367, -0.0556691252, 0.0246726833, 0.0592867546, -0.0763099641, -0.0536652729, -0.0144792134, 0.0241041929, 0.0369573198, -0.0339798369, 0.0655252412, 0.017150769, 0.00742537435, -0.0644143373, 0.0318899751, 0.0782283619, 0.053788498, -0.0436739773, 0.0545631573, 0.0120473728, 0.0495895632, 0.00140026235, 0.0545105748, -0.0610027611, 0.0325462185, -0.0469460115, -0.0801013783, -0.065732494, -0.0273557585, 0.00705487, 0.0460956655, 0.0582339391, 0.0451293401, 0.015506058, 0.0220106374, 0.05357752, -0.0199164934, 0.0128044821, -0.0172149613, -0.0648758411, -0.00792077184, 0.0437594317, -0.0594156645, 0.0466157645, 0.020353321, 0.0358234532, 0.0178049225, -0.0495107621, 0.0343288146, 0.000172282511, -0.0305531211, -0.0704465732, -0.03333297, 0.036025431, -0.0251944065, 0.0328318588, -0.0681014732, -0.0478571132, 0.0178122465, -0.0642979518, -0.0627185926, -0.0492984951, -0.0411759056, -0.000792284554, 0.00268011261, -0.0167066939, 0.0105258357, -0.0299905725, 0.0515289754, 0.0478962287, 0.0324450023, -0.0143145397, 0.033859, 0.0389672816, -0.0117780454, -0.00132585212, -0.0537697151, -0.0630962476, -0.0141722392, 0.0157111567, 0.0739339143, 0.0144058457, 0.0736769736, 0.0458855182, 0.0060422211, 0.0691158175, -0.0648749471, 0.0364844389, 0.0191261712, -0.0202334244, 0.00855864119, 0.0607685372, 0.056116581, 0.021420503, -0.0512891039, -0.00636156509, -0.0299295932, -0.00029848548, 0.0540916324, -0.0366805382, 0.0513958335, 0.071446307, 0.0168303959, -0.0333721638, 0.0246072076, 0.0158223938, -0.0163723622, 0.0187674761, 0.0429423265, -0.0323834717, -0.0444444753, 0.0208270308, 0.0528687648, -0.0535334051, 0.0349886157, 0.02470484, -0.066073, 0.0574602075, -0.0283770654, -0.042300541, -0.0152179552, -0.00253557763, 0.0731355697, -0.0750785097, 0.0623132028, -0.0714937747, -0.0249225888, -0.0016318257, 0.0224830881, 0.0717084557, -0.0164402463, 0.0428012647, 0.0731676668, -0.0504959188, -0.00682082819, 0.0641121864, -0.0404052399, -0.0222679432, 0.0163590014, 0.0221751221, 0.0224782266, -0.00427018246, 0.0525591709, 0.0294066127, -0.0163090639, -0.0115619572, -0.0580513738, -0.0378437079, -0.00229228102, -0.0649768859, 0.0340837091, -0.0302102864, 0.0239837766, -0.0679513365, -0.0134786749, 0.0222180914, -0.0738145486, -0.0569257811, -0.0283386149, 0.00267510233, -0.0130373035, 0.0461160131, -0.0608208627, -0.032169316, -0.00914333109, -0.0595887452, 0.0372455753, 0.00183885836, 0.0346351862, 0.0728105232, -0.0397299752, 0.0453906804, 0.0760348216, -0.00189105119, -0.0601671822, -0.0214840602, -0.0793803781, 0.057187967, -0.050147377, -0.0530604608, -0.0576586053, -0.0241960678, -0.00195150299, 0.0218220055, -0.080140546, 0.0158887785, 0.0149869109, -0.0444806777, -0.026766805, 0.0785646886, -0.00517919427, 0.0208439082, -0.0570765771, 0.0515732877, 0.0167429745, -0.0801420882, -0.0382699743, -0.00586638646, -0.0638863519, 0.0318394862, -0.0523413569, -0.0252878498, -0.0189771894, 0.0208196342, 0.023728868, 0.0148915006, -0.0450365171, 0.0475020036, 0.0260081198, 0.0113102868, -0.0617865138, 0.0403447486, 0.00657652365, -0.0259466488, -0.0659526959, 0.0318631269, -0.0388841033, 0.00313898898, -0.0714179426, -0.0668204352, -0.0249606986, 0.0609224215, -0.019272482, 0.0547086895, 0.0432850495, -0.00159069174, 0.0305210203, -0.0426964164, 0.00259116665, -0.037476141, -0.0519880541, 0.0252536051, 0.0635390282, -0.0370848961, -0.0641580895, 0.0520018972, -0.0180437397, -0.0128395129, -0.0550665334, 0.0700397715, -0.0542060137, 0.0366417803, 0.0338618793, 0.0607774593, 0.0280790962, -0.0350485332, -0.0592044145, -0.0732987896, -0.060884, -0.0258622244, 0.0230051223, 0.0706109777, -0.0242384989, -0.0629532188, -0.0172436815, -0.0757453665, -0.07058651, -0.0656154156, -0.07563705, -0.0697945207, 0.0177996103, 0.0649398118, 0.036263708, 0.0602147132, -0.0409758501, 0.0586561747, -0.0361374058, 0.0526833422, -0.0395628177, -0.00538292062, 0.0112011069, 0.0314964168, -0.0541555323, -0.06112995, -0.0463999361, 0.0393329971, -0.0536708049, 0.0487847924, -0.0736178, -0.0281521566, 0.0398225039, 0.0470023975, 0.0380318165, -0.0179258734, 0.0243783798, -0.0618403405, 0.0520041212, 0.00721219461, -0.0124168238, -0.0401520133, -0.0367078334, -0.0475117788, -0.00234545115, 0.0540330745, 0.0353205167, -0.0360206403, -0.037508674, -0.0552785434, 0.0200949274, -0.0337696783, 0.0498542, 0.0114974417, 0.0458072871, 0.0801467672, -0.00430999836, -0.0540267192, 0.0176444929, -0.043409545, 0.0541761182, -0.0256904215, 0.0225033183, 0.0124077061, -0.0492822565, -0.0285219457, -0.0701102391, 0.0512360744, 0.0750028193, 0.0447723679, -0.0467403606, 0.0159397889, 0.0209813416, -0.0782305747, -0.0305873435, 0.0306254849, 0.0683187917, 0.0237765424, 0.0633638278, -0.051152762, 0.0295073055, 0.0529899709, 0.00508845737, -0.0111950915, -0.0391207598, -0.0122288279, -0.0533214733, -0.0369623676, 0.0448111556, 0.0526681, 0.053506989, -0.0194316618, 0.00804993138, 0.0251607299, 0.0340598673, -0.00504660467, -0.0628437176, 0.0716390088, 0.0238012299, -0.0671370775, 0.0393189937, -0.0150426, -0.0736079589, -0.0587289073, -0.0240201615, -0.0227350444, -0.0601155646, 0.0104333237, -0.0538150966, 0.0310796592, -0.0384956561, 0.02052496, 0.01922944, -0.0318633057, -0.0472571328, 0.0395196378, -0.00904363114, -0.0369204916, -0.0289200414, -0.00876577385, 0.0357802548, -0.0469899289, 0.063481614, -0.0242249314, 0.0072392812, -0.00883386843, -0.05749752, -0.0601103082, -0.0562011115, 0.020695217, -0.0788045451, 0.0031404628, -0.0737583861, 0.0604321472, 0.0210978501, -0.0173135549, 0.0247234516, -0.0518781208, -0.00583983865, 0.0169364791, 0.0252354741, -0.0685797483, 0.00984013267, -0.05310582, -0.00551546039, -0.0490778089, 0.0300416872, -0.0356794707, -0.0363634378, 0.0426532514, -0.0388460979, -0.0523887724, 0.0513214208, 0.050605014, -0.068473734, 0.0404675342, -0.0114442017, 0.0691954941, 0.0117183793, 0.0157065559, -0.0683604777, 0.0575855896, 0.0150504531}
	c       = []float32{0.0426259413, 0.000247844495, -0.00789495278, 0.0185192674, -0.0347096696, -0.0299674775, 0.0601730272, 0.0322844572, -0.0349422395, 0.0419840515, 0.0388423204, 0.051343441, 0.0225083437, 0.011862807, 0.016792085, 0.0013664501, -0.049429927, 0.0654806346, 0.031800203, -0.0605862848, 0.0303729586, 0.0598893575, 0.0292845853, -0.0498867705, -0.0180505775, -0.0164265465, 0.0338371024, 0.00684795249, -0.036202848, -0.064306587, -0.0144395987, -0.0781143829, -0.00782266632, 0.0743015483, -0.0419654101, 0.0212138239, -0.0342342146, -0.0445963629, -0.068787016, 0.0356694199, -0.0418141484, 0.0170887709, -0.0696913, 0.0205935221, -0.0709767118, 0.0194425713, -0.0308107492, -0.0113516115, 0.0168583617, 0.0715505108, 0.0440684631, -0.0400892086, 0.0748172104, 0.0204741433, -0.0343597196, -0.0243712831, 0.0571313873, 0.0375899598, 0.00360253407, -0.00502119, 0.0224306583, -0.0289351884, -0.0456877202, 0.0333887078, -0.0242255144, 0.0391257517, -0.00824136473, -0.0350849815, 0.0634823, -0.0560816787, -0.0754696727, -0.0392274745, -0.065271914, -0.0501960032, -0.0181480572, 0.00490102405, -0.068528004, 0.0763848275, 0.0365093797, 0.00311318226, 0.00759554142, 0.0762328953, -0.0724229962, 0.0508033037, -0.0186903849, -0.015031402, -0.0378616303, 0.0364189595, -0.0175126325, -0.0658709928, 0.0397528708, -0.0105886618, 0.00847854, 0.0657316595, -0.0777166188, -0.0251198877, -0.0633101314, 0.0102259144, 0.0429072902, 0.0512455069, 0.0466829762, -0.00226379139, -0.0448440127, -0.0400537439, -0.0621774569, -0.0519671105, 0.0341612101, -0.0620939769, -0.0243919082, 0.0542557649, 0.0222174879, -0.0300791953, -0.04013386, 0.00151601702, -0.066493012, 0.027343547, 0.0455269031, -0.0293539744, -0.0509497672, -0.0175418425, 0.0166396014, 0.0681335852, -0.0364992805, -0.0155594107, -0.00573649956, 0.0338023901, 0.0686117113, 0.0635041893, 0.0156313982, 0.0512556396, 0.0117316805, 0.068332389, 0.0703150406, 0.0466994457, 0.0435056351, 0.0362251885, 0.0702418238, 0.0167645831, -0.000122739744, -0.0745077133, -0.0430038534, -0.00278543332, 0.0615088455, 0.00313600828, 0.0300078727, 0.0657900795, 0.0494930111, -0.0203280654, -0.0427178703, -0.00213314686, 0.0397827066, 0.0283527207, -0.0598849803, -0.0787723213, -0.0585119687, -0.0421796851, -0.070611991, -0.0739299729, -0.066740334, 0.0275248326, -0.0600685775, 0.0268942341, 0.0374242812, -0.0111653516, -0.0317390636, -4.08895285e-05, 0.00363286329, 0.0613516383, 0.0164639, 0.0506036691, -0.0390318111, 0.0490349121, -0.0351489186, -0.0231169928, 0.0757789, -0.0437003784, 0.0586644746, 0.00458718697, -0.0272961836, -0.0288869496, 0.0554678887, -0.0583049692, 0.0554141439, 0.0022560975, -0.0504367463, 0.0740983635, -0.0350303911, 0.0182810053, 0.0185817145, 0.0179578792, 0.0388925113, 0.00848727, 0.077301085, -0.0498839729, 0.0632115528, -0.0551629886, -0.0652668104, -0.0165083185, -0.0394865498, 0.0220604651, -0.0791283846, -0.064098537, 0.0147655653, 0.00477863243, 0.0304877739, -0.00556538673, -0.0251436979, 0.0637973, -0.0727101341, 0.0534824505, -0.0311435051, 0.0778934285, 0.0356432721, -0.0535553806, -0.044663012, 0.0131332977, -0.0566868521, 0.0279786158, -0.00620920211, 0.016006, 0.0148310438, -0.00444768229, 0.0375422128, 0.0595160052, 0.0477849506, -0.0574212894, 0.0461419784, 0.0221473798, 0.013230239, 0.0209356807, 0.0100981798, -0.0487372838, -0.0106534436, 0.0794506744, 0.0575029403, 0.0281326268, 0.00799244829, -0.0162519682, -0.0391452275, -0.0199513268, 0.0511992164, -0.0552517064, -0.0607487261, 0.0432926379, 0.0177015457, -0.0439925864, 0.0657712, -0.00349715259, -0.0376248062, 0.0265239738, 0.0735492632, -0.0326636545, 0.0273447763, 0.0208103936, -0.0336843506, 0.00537398783, -0.0446599722, -0.0282049514, 0.0123174675, -0.0696329251, -0.042490419, -0.0191909838, -0.0179831628, 0.0150339967, 0.0158522651, 0.0789267793, 0.0752272084, -0.0275217798, 0.0434283204, 0.0463862196, 0.0110831307, -0.0351728871, -0.0529312789, 0.0307169631, 0.0237498842, 0.0156475771, -0.0392598063, -0.0379121676, 0.0738771334, 0.0402941629, 0.0482529141, -0.0339081958, -0.0398005471, 0.020688476, 0.0397768393, 0.0145387799, 0.038565252, 0.0783465952, -0.0275911633, 0.020850189, -0.0230701268, -0.0421980284, 0.0737898275, -0.0682536364, 0.0300547704, -0.00688858936, 0.0751569942, 0.0742180049, -0.0715417117, 0.030660959, 0.0159525778, -0.0748701, -0.00662668096, 0.0168824438, 0.044495292, 0.0117835253, 0.0720647424, 0.0585808791, -0.0270057935, 0.0421289615, 0.018085707, -0.0234200656, -0.0216797497, -0.0775525421, -0.0666294843, -0.057647571, 0.00557768345, 0.0378632918, -0.0274725296, -0.0486044697, 0.00728271063, -0.0696587488, 0.0118047548, 0.0353518724, 0.0332931, -0.013836056, 0.063713111, 0.00190617971, -0.0144758895, -0.0190828405, -0.0695341304, -0.0664396957, 0.0425602198, 0.0310669299, -0.0391755924, 0.0686327666, -0.054341577, 0.0623325668, 0.0132580586, 0.0632241219, -0.0660485, -0.00143406761, 0.0345072933, -0.0217752978, -0.0392836481, -0.0708699673, 0.0490542725, 0.0452715456, 0.0162645765, -0.00643606577, 0.027894536, -0.0617834702, -0.0193751734, 0.0480192192, -0.0552020632, 0.0474840924, -0.0776373, -0.0488742143, 0.0521476343, -0.0535635576, -0.00360102556, -0.0564843751, 0.0493378565, 0.0557440035, -0.0231150519, -0.0566255152, 0.0648689717, 0.0745308772, 0.0511973947, -0.0624413714, 0.0744029284, -0.0654892549, -2.15349319e-05, -0.0342448913, -0.0110022929, -0.0525946915, 0.0418239757, -0.0557224415, -0.0606122762, -0.0218862556, 0.0460708253, -0.00848834682, -0.00687262975, -0.0164800826, -0.0162858665, -0.0494011, -0.0235263593, 0.0429178588, 0.00705464045, -0.0361720659, -0.0412671901, -0.0588854663, 0.0673511252, -0.0111466059, 0.0134315491, 0.0625955239, -0.0541810505, -0.0210408233, 0.0210767183, 0.0182508212, 0.00098504778, 0.0172579847, -0.0762689784, -0.0579388067, -0.0676599815, -0.0058267503, -0.0650699288, 0.0383815318, 0.0141922906, 0.00530988444, -0.0324290469, 0.0109263686, 0.0626516864, 0.0106877, -0.0777650699, 0.0380164534, 0.0722932592, -0.0111903884, -0.0284012537, -0.0431703664, -0.00236203219, 0.0305692013, -0.0427916721, -0.0454998, 0.0274503902, 0.0113665815, -0.00978372525, 0.0581936128, -0.0485157408, 0.0732899159, 0.0764744058, 0.0433558412, -0.00208100514, 0.00401930511, 0.0442135334, 0.0511546656, -0.0129372664, 0.0671222135, -0.0320124626, 0.0422955379, 0.0524903759, -0.0192469638, 0.00549389236, 0.0165174231, -0.00929734949, -0.0752532259, 0.0387188271, -0.0369307846, -0.0213076063, 0.0315568708, 0.0597445779, 0.00362493703, 0.0565611608, 0.0693517551, 0.0421993732, -0.022399338, 0.0584620684, -0.0470005907, -0.0121026682, 0.0615607426, -0.0203918628, 0.0403971151, 0.0641579702, 0.0139016602, 0.0071283509, -0.0109552667, -0.0196922589, -0.0511402301, 0.0681422725, 0.00529266475, -0.000510437589, 0.0126794344, 0.0719744042, -0.0637721717, 0.000181884, 0.0194388255, 0.00702118222, 0.0722019598, 0.0225978624, -0.0193935465, 0.0561193191, -0.0496217646, -0.0136270802, 0.0648868382, 0.0479515195, -0.00883758441, -0.0645997599, 0.0674590096, 0.0249822922, 0.042821452, -0.0529954955, -0.0262952466, -0.0488925, -0.0135007966, 0.0314989872, -0.0224809106, 0.0612644963, -0.0654362142, -0.0142491879, 0.0370175727, -0.0204567052, -0.00382856559, -0.0348485038, -0.077353, 0.00873385, 0.0482775196, 0.0145230936, -0.0612298325, 0.0448768623, 0.0595336, -0.0730962232, -0.0756614208}
	v3UnitX = []float32{1, 0, 0}
	v3UnitY = []float32{0, 1, 0}
	v3UnitZ = []float32{0, 0, 1}
	v3Unit  = []float32{1, 1, 1}
)

func TestCosine(t *testing.T) {
	testsCases := [][]float32{a, c, v3Unit, v3UnitX, v3UnitY, v3UnitZ}
	for _, tc := range testsCases {
		r, err := Cosine(tc, tc)
		require.NoError(t, err)
		require.Equal(t, float64(1), r)
	}
}

func TestCosineNaive(t *testing.T) {
	testsCases := [][]float32{a, c, v3Unit, v3UnitX, v3UnitY, v3UnitZ}
	for _, tc := range testsCases {
		r, err := CosineNaive(tc, tc)
		require.NoError(t, err)
		require.Equal(t, float64(1), r)
	}
}

func TestCosineLoopMerge(t *testing.T) {
	testsCases := [][]float32{a, c, v3Unit, v3UnitX, v3UnitY, v3UnitZ}
	for _, tc := range testsCases {
		r, err := CosineLoopMerge(tc, tc)
		require.NoError(t, err)
		require.Equal(t, float64(1), r)
	}
}

func TestCosineSplitProd(t *testing.T) {
	testsCases := [][]float32{a, c, v3Unit, v3UnitX, v3UnitY, v3UnitZ}
	for _, tc := range testsCases {
		r, err := CosineSplitProd(tc, tc)
		require.NoError(t, err)
		require.Equal(t, float64(1), r)
	}
}

func TestCosineBlock(t *testing.T) {
	testsCases := [][]float32{a, c, v3Unit, v3UnitX, v3UnitY, v3UnitZ}
	for _, tc := range testsCases {
		r, err := CosineBlock(tc, tc)
		require.NoError(t, err)
		require.Equal(t, float64(1), r)
	}
}

func TestCosineOneFunc(t *testing.T) {
	testsCases := [][]float32{a, c, v3Unit, v3UnitX, v3UnitY, v3UnitZ}
	for _, tc := range testsCases {
		t.Run(fmt.Sprintf("%v", tc), func(t *testing.T) {
			r, err := CosineOneFunc(tc, tc)
			require.NoError(t, err)
			require.Equal(t, float64(1), r)
		})
	}

}

var similar float64

func BenchmarkCosine(b *testing.B) {
	var s float64
	for n := 0; n < b.N; n++ {
		// always record the result to prevent
		// the compiler eliminating the function call.
		s, _ = Cosine(a, c)
	}
	// always store the result to a package level variable
	// so the compiler cannot eliminate the Benchmark itself.
	similar = s
}

func BenchmarkCosineNaive(b *testing.B) {
	var s float64
	for n := 0; n < b.N; n++ {
		// always record the result to prevent
		// the compiler eliminating the function call.
		s, _ = CosineNaive(a, c)
	}
	// always store the result to a package level variable
	// so the compiler cannot eliminate the Benchmark itself.
	similar = s
}

func BenchmarkCosineLoopeMerge(b *testing.B) {
	var s float64
	for n := 0; n < b.N; n++ {
		// always record the result to prevent
		// the compiler eliminating the function call.
		s, _ = CosineLoopMerge(a, c)
	}
	// always store the result to a package level variable
	// so the compiler cannot eliminate the Benchmark itself.
	similar = s
}

func BenchmarkCosineSplitProd(b *testing.B) {
	var s float64
	for n := 0; n < b.N; n++ {
		// always record the result to prevent
		// the compiler eliminating the function call.
		s, _ = CosineSplitProd(a, c)
	}
	// always store the result to a package level variable
	// so the compiler cannot eliminate the Benchmark itself.
	similar = s
}

func BenchmarkCosineBlock(b *testing.B) {
	var s float64
	for n := 0; n < b.N; n++ {
		// always record the result to prevent
		// the compiler eliminating the function call.
		s, _ = CosineBlock(a, c)
	}
	// always store the result to a package level variable
	// so the compiler cannot eliminate the Benchmark itself.
	similar = s
}

func BenchmarkCosineOnFuncFix(b *testing.B) {
	var s float64
	for n := 0; n < b.N; n++ {
		// always record the result to prevent
		// the compiler eliminating the function call.
		s, _ = CosineOneFunc(a, c)
	}
	// always store the result to a package level variable
	// so the compiler cannot eliminate the Benchmark itself.
	similar = s
}
func TestCosineCompare(t *testing.T) {
	fmt.Printf("len: %v\n", len(a))
	cosineFuncs := []func(u, v []float32) (float64, error){
		Cosine,
		CosineNaive,
		CosineLoopMerge,
		CosineSplitProd,
		CosineOneFunc,
		CosineBlock,
	}
	names := []string{
		"Cosine         ",
		"CosineNaive    ",
		"CosineLoopMerge",
		"CosineSplitProd",
		"CosineOneFunc  ",
		"CosineBlock    ",
	}
	var res []float64
	for _, f := range cosineFuncs {
		r, err := f(a, c)
		require.NoError(t, err)
		res = append(res, r)
	}
	for i, r := range res {
		fmt.Printf("%s \t%v\n", names[i], r)
	}
}
